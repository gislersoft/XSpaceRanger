<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <style media='screen' type='text/css'>
        @font-face {
            font-family: SpaceAge;
            src: url('./assets/fonts/spaceage.ttf');
        }
    </style>
</head>
<body>
    <script>
    class Bullet extends Phaser.Physics.Arcade.Sprite
    {
        constructor (scene, x, y)
        {
            super(scene, x, y, 'laser');
        }

        fire (x, y)
        {
            this.body.reset(x, y);

            this.setActive(true);
            this.setVisible(true);

            this.setVelocityY(-3000);
            this.setScale(0.2);
        }

        preUpdate (time, delta)
        {
            super.preUpdate(time, delta);

            if (this.y <= -32)
            {
                this.setActive(false);
                this.setVisible(false);
            }
        }
    }

    class Bullets extends Phaser.Physics.Arcade.Group
    {
        constructor (scene)
        {
            super(scene.physics.world, scene);

            this.createMultiple({
                frameQuantity: 1,
                key: 'bullet',
                active: false,
                visible: false,
                classType: Bullet
            });
        }

        fireBullet (x, y)
        {
            let bullet = this.getFirstDead(false);

            if (bullet)
            {
                bullet.fire(x, y);
            }
        }
    }


    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 200 }
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: updateScene
        }
    };

    var game = new Phaser.Game(config);

    // Background variables
    var backgroundY = 300;
    var background;
    var backgroundTop;

    // Spaceship variables
    var speed = 1;
    var nave;
    var playing = false;
    var naveEscalaInicial = 1;
    var naveEscalaFinal = 0.2;
    var naveVelocidadEscalado = 0.01;
    var naveEscala = naveEscalaInicial;
    var superSpeed = 40;
    var superSpeedActivated = false;

    var engineFire;

    // Teclado
    var cursors;

    var speedtank;
    var speedtankY = -50;

    var turboSFX;

    var particlesTank;
    var timerTankParticles;
    var timerStopHyperSpeed;
    var timerCreateTank;
    var timerCreateTankInitiated = false;
    var self;

    var bullets;

    function preload ()
    {
        this.load.setBaseURL('http://localhost/juego/');

        // Loading images
        this.load.image('sky', 'assets/img/space3.png');
        this.load.image('red', 'assets/img/red.png');
        this.load.image('violet', 'assets/img/violet.png');
        this.load.image('pelota','assets/img/pelota.png');
        this.load.image('nave','assets/img/spaceship.png');
        this.load.image('speedtank','assets/img/speedtank.png');
        this.load.image('laser', 'assets/img/laser.png');

        // Loading sound
        this.load.audio('music', 'assets/music/backgroundmusic.mp3');
        this.load.audio('turboSFX', 'assets/sfx/turboRemastered.mp3');
    }

    function create ()
    {
        self = this;
        cursors = this.input.keyboard.createCursorKeys();

        if (!playing && !this.load.isLoading()) {
            playing = true
            var music = this.sound.add('music') // this works
            music.loop = true;
            // music.play();
        }

        turboSFX = this.sound.add('turboSFX');

        backgroundTop = this.add.image(400, backgroundY - 600, 'sky');
        background = this.add.image(400, backgroundY, 'sky');

        nave = this.physics.add.image(400,500,'nave');
        nave.setScale(naveEscala);
        nave.setCollideWorldBounds(true);

        this.add.text(10, 10, 'SCORE:', { fontFamily: 'SpaceAge' });

        engineFire = createParticlesBooster();

        createTank();

        this.bullets = new Bullets(this);

    }

    function updateScene ()
    {
        if (superSpeedActivated) {
            speed = superSpeed;
        }
        doScrolling();
        doSpaceShipScaleEffect();

        if (cursors.left.isDown)
        {
            nave.setVelocityX(-300);
        }
        else if (cursors.right.isDown)
        {
            nave.setVelocityX(300);
        }

        if (cursors.up.isDown)
        {
            nave.setVelocityY(-300);
        }
        else if (cursors.down.isDown)
        {
            nave.setVelocityY(300);
        }

        if (cursors.space.isDown) {
            this.bullets.fireBullet(nave.x, nave.y - 60);
        }

        speedtankY = speedtankY + speed;
        speedtank.rotation += 0.01;
        speedtank.setPosition(speedtank.x, speedtankY);
        if (speedtankY > 620) {
            speedtank.destroy();
            initCreateTankTimer();
        }
    }

    function tankCollision() {
        speedtank.destroy();
        superSpeedActivated = true;
        engineFire.setLifespan(600);
        // turboSFX.play();
        particlesTank.visible = true;
        timerTankParticles = self.time.delayedCall(800, stopTankParticles, [], self);
        timerStopHyperSpeed = self.time.delayedCall(3000, stopHyperSpeed, [], self);
        initCreateTankTimer();
    }

    // Hace el efecto de la nave llegando
    function doSpaceShipScaleEffect() {
        naveEscala = naveEscala - naveVelocidadEscalado;
        if (naveEscala < naveEscalaFinal) {
            naveEscala = naveEscalaFinal;
            engineFire.visible = true;
            speed = 3;
        }
        nave.setScale(naveEscala);

        nave.setVelocity(0);
    }

    // Scrolls the background
    function doScrolling() 
    {
        backgroundY = backgroundY + speed;

        if (backgroundY > 900) {
            backgroundY = 300;
        }

        backgroundTop.setPosition(400, backgroundY - 600);
        background.setPosition(400, backgroundY);
    }

    // Crea el sistema de particulas cuando colisiona con el tanque
    function createTankParticleSystem(objectToFollow, particles) {
        var emitter;
        emitter = particles.createEmitter({
            speed: 20,
            lifespan: 30,
            scale: { start: 1, end: 5 },
            blendMode: 'ADD'
        });
        emitter.startFollow(objectToFollow);
        emitter.setScale(2.0);
        emitter.visible = false;
        return emitter;
    }

    function createParticlesBooster() {
        var particles = self.add.particles('red');
        emitter = particles.createEmitter({
            speed: 10,
            accelerationY: 20000,
            lifespan: 60,
            scale: { start: 1, end: 0 },
            blendMode: 'ADD'
        });
        emitter.startFollow(nave);
        emitter.followOffset.set(0, 50);
        emitter.setScale(0.5);
        emitter.visible = false;
        return emitter;
    }

    // Crea el tanque y sus particulas
    function createTank() {
        speedtankY = -50;
        speedtank = self.physics.add.image(Phaser.Math.Between(0, 799), 60, 'speedtank');
        speedtank.setScale(0.1);

        particlesTank = createTankParticleSystem(nave, self.add.particles('violet'));

        self.physics.add.collider(nave, speedtank, function (nave, speedtank) {
            tankCollision();
        });

        timerCreateTankInitiated = false;
    }

    function stopTankParticles() {
        particlesTank.visible = false;
    }

    function stopHyperSpeed() {
        superSpeedActivated = false;
        emitter.setLifespan(60);
    }

    function initCreateTankTimer() {
        if (!timerCreateTankInitiated) {
            timerCreateTankInitiated = true;
            timerCreateTank = self.time.delayedCall(Phaser.Math.Between(4000, 30000), createTank, [], self);
        }
    }
    </script>

</body>
</html>